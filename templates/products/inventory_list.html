{% extends 'base.html' %}
{% block title %}Control de Inventario{% endblock %}

{% block content %}
    <h1><i class="fas fa-warehouse"></i> Inventario por Sucursal</h1>
    <p class="lead text-muted">Seleccione una sucursal para ver el stock en tiempo real y realizar ajustes.</p>
    <hr>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title">Filtrar por Sucursal</h5>
            <form method="get" class="row g-3 align-items-center" id="inventory-filter-form">
                <div class="col-md-8">
                    <label for="branch_select" class="visually-hidden">Sucursal</label>
                    <select name="branch_id" id="branch_select" class="form-select" required>
                        <option value="">-- Elige una Sucursal --</option>
                        
                        {% for branch in branches %}
                            <option value="{{ branch.id }}">{{ branch.name }} ({{ branch.address|truncatechars:30 }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">Mostrar Inventario</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="inventory-results" class="mt-5">
        <div class="alert alert-info text-center">
            Seleccione una sucursal arriba para cargar los datos de stock.
        </div>

        <table class="table table-striped table-bordered d-none" id="inventory-table">
            <thead class="table-dark">
                <tr>
                    <th>Producto</th>
                    <th>SKU</th>
                    <th>Stock Actual</th>
                    <th>Punto Reorden</th>
                    <th>Estado</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="inventory-table-body">
                </tbody>
        </table>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    // ⚠️ CRITICAL: The API endpoint URL from Django's resolver
    const apiEndpoint = "{% url 'products:inventory-list-api' %}"; 

    document.getElementById('inventory-filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const branchId = document.getElementById('branch_select').value;
        
        if (!branchId) {
            alert('Por favor, selecciona una sucursal.');
            return;
        }

        // Fetch API request
        fetch(`${apiEndpoint}?branch=${branchId}`, {
            method: 'GET',
            headers: {
                // IMPORTANT: Send the JWT token for authorization (401/403 Fix)
                'Authorization': 'Bearer ' + localStorage.getItem('access_token') 
            }
        })
        .then(response => {
            // Check for API errors (401/403/404)
            if (!response.ok) {
                // Provide specific feedback for authentication issues
                if (response.status === 401 || response.status === 403) {
                     alert('Error de autenticación. Por favor, obtén un token JWT en el login y vuelve a intentar.');
                }
                throw new Error('API request failed: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            // Renderizar datos en la tabla
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = '';
            document.getElementById('inventory-table').classList.remove('d-none');
            
            if (data && data.length > 0) {
                data.forEach(item => {
                    // NOTE: item.product_sku must be returned by the Serializer
                    const row = `<tr>
                        <td>${item.product_name}</td>
                        <td>${item.product_sku || 'N/A'}</td> 
                        <td>${item.stock}</td>
                        <td>${item.reorder_point}</td>
                        <td><span class="badge bg-${item.stock <= item.reorder_point ? 'danger' : 'success'}">${item.stock <= item.reorder_point ? 'BAJO' : 'OK'}</span></td>
                        <td><a href='#' class='btn btn-sm btn-outline-warning'>Ajustar</a></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } else {
                 tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay inventario registrado en esta sucursal.</td></tr>';
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            // Re-hide the table on error
            document.getElementById('inventory-table').classList.add('d-none');
        });
    });
</script>
{% endblock %}