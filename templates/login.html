{% extends 'base_minimal.html' %} 
{% block title %}Iniciar Sesión{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card shadow-lg p-3 mt-5">
            <h3 class="card-title text-center mb-4">Acceso al Sistema</h3>

            <form method="post" action="{% url 'login' %}">
                {% csrf_token %}
                <p class="text-muted text-center">Login por Sesión (Requerido para vistas Template)</p>

                {% if form.errors %}
                    <div class="alert alert-danger">
                        Usuario o contraseña incorrectos.
                    </div>
                {% endif %}

                <div class="mb-3">
                    <label for="id_username" class="form-label">Usuario</label>
                    <input type="text" name="username" id="id_username" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="id_password" class="form-label">Contraseña</label>
                    <input type="password" name="password" id="id_password" class="form-control" required>
                </div>
                
                <button type="submit" class="btn btn-primary w-100 mb-3">Iniciar Sesión</button>
                <input type="hidden" name="next" value="{{ next }}">
            </form>
            
            <hr>

            <p class="text-muted text-center mt-3">O usa la autenticación API (JWT):</p>
            <button id="btn-get-jwt" class="btn btn-success w-100">Obtener Token JWT (API)</button>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('btn-get-jwt').addEventListener('click', function() {
        const username = document.getElementById('id_username').value;
        const password = document.getElementById('id_password').value;

        if (!username || !password) {
            alert('Por favor, ingresa usuario y contraseña para solicitar el JWT.');
            return;
        }

        // ⚠️ CORRECCIÓN: Usar el namespace 'accounts' para resolver la URL del token.
        // Esto resuelve la NoReverseMatch.
        fetch('{% url "accounts:token_obtain_pair" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username: username, password: password })
        })
        .then(response => response.json())
        .then(data => {
            if (data.access) {
                // Almacenar el token en localStorage 
                localStorage.setItem('access_token', data.access);
                localStorage.setItem('refresh_token', data.refresh);
                alert('Token JWT obtenido y guardado en localStorage! Útil para consumir /api/ endpoints.');
                // Opcional: Redirigir al dashboard si se obtiene el token.
                // window.location.href = "{% url 'dashboard' %}";
            } else {
                alert('Error al obtener token: ' + (data.detail || 'Credenciales inválidas.'));
            }
        })
        .catch(error => console.error('Error:', error));
    });
</script>
{% endblock %}