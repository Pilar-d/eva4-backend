{% extends 'base.html' %}
{% block title %}Crear Nuevo Usuario{% endblock %}

{% block content %}
<header class="mb-4">
    <h1><i class="fas fa-user-plus"></i> Gestión de Personal</h1>
    <p class="lead text-muted">
        {% if user.role == 'super_admin' %}
            Crea una nueva cuenta de <strong>Administrador Cliente (Tenant)</strong> y asígnale su empresa.
        {% elif user.role == 'admin_cliente' %}
            Crea cuentas de <strong>Gerentes</strong> o <strong>Vendedores</strong> para la compañía:
            <strong>{{ user.company.name }}</strong>.
        {% endif %}
    </p>
</header>

<hr>

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        {% endif %}

        <form method="post" 
              action="{% url 'accounts:user_create_api' %}" 
              class="needs-validation"
              novalidate>
              
            {% csrf_token %}

            <!-- USERNAME -->
            <div class="mb-3">
                <label class="form-label fw-bold">Nombre de Usuario (Login)</label>
                <input type="text" 
                       name="username" 
                       class="form-control" 
                       value="{{ post_data.username|default:'' }}" 
                       required>
            </div>

            <!-- EMAIL -->
            <div class="mb-3">
                <label class="form-label fw-bold">Correo Electrónico</label>
                <input type="email" 
                       name="email" 
                       class="form-control" 
                       value="{{ post_data.email|default:'' }}" 
                       required>
            </div>

            <!-- RUT -->
            <div class="mb-3">
                <label class="form-label fw-bold">RUT Chileno</label>
                <input type="text" 
                       name="rut" 
                       class="form-control"
                       placeholder="12.345.678-9"
                       value="{{ post_data.rut|default:'' }}"
                       pattern="[0-9]{1,2}\.?[0-9]{3}\.?[0-9]{3}-[0-9Kk]"
                       required>
            </div>

            <!-- PASSWORD -->
            <div class="mb-3">
                <label class="form-label fw-bold">Contraseña</label>
                <input type="password" 
                       name="password" 
                       class="form-control" 
                       required>
            </div>

            <!-- ROLE -->
            <div class="mb-3">
                <label class="form-label fw-bold">Rol a Asignar</label>
                <select name="role" class="form-select" id="id_role" required>
                    <option value="">-- Seleccionar Rol --</option>
                    {% for role_code, role_name in allowed_roles %}
                        <option value="{{ role_code }}"
                                {% if post_data.role == role_code %}selected{% endif %}>
                                {{ role_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- BRANCH (solo Admin Cliente) -->
            {% if user.role == 'admin_cliente' %}
            <div class="mb-3 border p-3 bg-light rounded" id="branch-container">
                <label class="form-label fw-bold">Sucursal</label>
                <select name="branch" id="id_branch" class="form-select">
                    <option value="">-- Seleccionar Sucursal --</option>
                    {% for branch in branches %}
                        <option value="{{ branch.id }}"
                                {% if post_data.branch == branch.id|stringformat:"s" %}
                                    selected
                                {% endif %}>
                            {{ branch.name }}
                        </option>
                    {% endfor %}
                </select>
                <small class="text-muted">Sucursal obligatoria para Gerentes y Vendedores.</small>
            </div>
            {% endif %}

            <!-- COMPANY (solo SuperAdmin) -->
            {% if user.role == 'super_admin' %}
            <div class="mb-3 border p-3 bg-light rounded">
                <label class="form-label fw-bold">Asignar Compañía (Tenant)</label>
                <select name="company" class="form-select" required>
                    <option value="">-- Seleccionar Compañía --</option>
                    {% for company in companies %}
                        <option value="{{ company.id }}"
                                {% if post_data.company == company.id|stringformat:"s" %}
                                    selected
                                {% endif %}>
                            {{ company.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <hr>
            <div class="text-end">
                <button class="btn btn-success btn-lg">
                    <i class="fas fa-save"></i> Crear Usuario
                </button>
            </div>

        </form>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
    (function () {
        'use strict'

        const form = document.querySelector('.needs-validation');
        const roleSelect = document.getElementById('id_role');
        const branchSelect = document.getElementById('id_branch');

        function updateBranchRequirement() {
            if (!branchSelect) return;

            const selectedRole = roleSelect.value;
            const requiredRoles = ['gerente', 'vendedor'];

            if (requiredRoles.includes(selectedRole)) {
                branchSelect.required = true;
            } else {
                branchSelect.required = false;
            }
        }

        updateBranchRequirement();
        roleSelect.addEventListener('change', updateBranchRequirement);

        // Validación submit
        form.addEventListener('submit', function (event) {
            if (branchSelect && branchSelect.required && !branchSelect.value) {
                branchSelect.setCustomValidity("Debe seleccionar una sucursal.");
            } else if (branchSelect) {
                branchSelect.setCustomValidity("");
            }

            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            form.classList.add('was-validated');
        });
    })();
</script>
{% endblock %}
